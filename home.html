<!--
// (C) 2017 Yamato Digital Audio
// Author: Malin af Lääkkö
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chat Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3.css">
    <link href="/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="/css/menus.css" rel="stylesheet" type="text/css"/>
    <link href="/css/modal.css" rel="stylesheet" type="text/css"/>

    <style>

        ul {
            font:  18px Comic Sans MS , cursive, sans-serif;
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;

        }

        li {
            #float: left;
        }


        .dropbtn {
            padding-top: 3px;
        }
        #SelectedRoom {
            padding-left: 2px;
            padding-top: 4px;
        }

        li button, .dropbtn {
            display: inline-block;
            color: white;
            text-align: center;
            #padding: 14px 16px;
            text-decoration: none;
        }

        li button:hover, .dropdown:hover .dropbtn {
            background-color: rgb(148, 175, 240);
        }

        li.dropdown {
            display: inline-block;
        }

        .dropdown-content {
            border-radius: 10%;
            border-style:solid;
            border-color: #88a3df;
            display: none;
            position: absolute;
            background-color: rgba(162, 190, 252, 0);
            width: auto;
            padding: 10px;
            -webkit-box-shadow:  10px 10px 5px gray;
            -moz-box-shadow:  10px 10px 5px gray;
            box-shadow:  8px 8px 5px gray;
            z-index: 1;
        }

        .dropdown-content button {

            width: 12em;
            #text-shadow: 2px 2px 4px #000000;
            color: #000000;
            background-color: #a2befc;
            padding: 2px;
            text-decoration: none;
            display: block;
            text-align: left;
            border-radius: 10%;
        }

        .dropdown-content button:hover {background-color: #94aff0
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script type="text/javascript">


        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {

            //ev.dataTransfer.effectAllowed = "copy";
            ev.dataTransfer.setData("text", ev.target.id);
            var data = ev.dataTransfer.getData("text", ev.target.id);
            console.log(ev.target.id);
            var current = document.getElementById("centerNenu");
            current.appendChild(document.getElementById(data));
        }

        function drop(ev) {
            //console.trace("dropped");
            ev.preventDefault();
            ev.dataTransfer.dropEffect = "copy";
            var data = ev.dataTransfer.getData("text");
            ev.target.appendChild(document.getElementById(data));
            var current = document.getElementById("centerNenu");
            current.appendChild(document.getElementById(data));


            console.log(data);

        }

        window.onload = function () {
            var conn;
            var msg = document.getElementById("msg");
            var sender = document.getElementById("sender");
            var log = document.getElementById("log");
            var currentUsers = document.getElementById("CurrentUsers");
            modal.style.display = "none";

            function appendNewUser(message) {
                var child = document.getElementById(message.token);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                }
                var newUser = document.createElement("li");
                newUser.setAttribute("id", message.token);

                image = document.createElement("img");
                image.setAttribute("src", message.pictureURL);

                newUser.appendChild(image);
                var name = document.createElement("span");
                name.innerText = message.sender;
                newUser.appendChild(name);
                currentUsers.appendChild(newUser);
            }

            function removeUser(message) {
                var child = document.getElementById(message.token);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                }
            }

            function appendLog(item) {
                var doScroll = log.scrollTop === log.scrollHeight - log.clientHeight;
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }
            }

            function sendMessage(op, msg) {
                var t = new Date();
                var time = t.getDate() + " " + t.getHours() + ":" + t.getMinutes() + ":" + t.getSeconds();
                var message = {
                    "op": op,
                    "timestamp": time,
                    "token": "{{with .Person}}{{.Token}}{{end}}",
                    "sender": "secret",
                    "pictureURL": "secret",
                    "Gender": "secret",
                    "content": msg
                };
                var json_message = JSON.stringify(message);
                console.log("send json message");
                conn.send(json_message);
                msg.value = "";
                return true;
            }

            document.getElementById("MainButton").onclick = function () {
                $("#SelectedRoom").text("Main");
                $("#log").empty();
                sendMessage("ChangeRoom", "Main");
            };

            document.getElementById("ReimersHotelButton").onclick =function () {
                $("#SelectedRoom").text("Reimers Hotel");
                $("#log").empty();
                sendMessage("ChangeRoom", "ReimersHotel");
            };

            document.getElementById("EvaMonikaMalinButton").onclick =function () {
                $("#SelectedRoom").text("EvaMonikaMalin");
                $("#log").empty();
                sendMessage("ChangeRoom", "Eva Monika Malin");
            };

            document.getElementById("GayButton").onclick = function () {
                $("#SelectedRoom").text("Gay");
                $("#log").empty();
                sendMessage("ChangeRoom", "Gay");
            };

            document.getElementById("LesbianButton").onclick =function () {
                $("#SelectedRoom").text("Lesbian");
                $("#log").empty();
                sendMessage("ChangeRoom", "Lesbian");
            };

            document.getElementById("JapaneseButton").onclick =function () {
                $("#SelectedRoom").text("日本語屋");
                $("#log").empty();
                sendMessage("ChangeRoom", "Japanese");
            };
            document.getElementById("TransButton").onclick =function () {
                $("#SelectedRoom").text("Trans");
                $("#log").empty();
                sendMessage("ChangeRoom", "Trans");
            };




            document.getElementById("form").onsubmit = function () {

                if (!conn) {
                    return false;
                }

                if (!msg.value) {
                    return false;
                }

                sendMessage("Message", msg.value);

                msg.value = "";
                return false;
            };

            function myFunction(id) {
                console.log("clicked");
                var x = document.getElementById(id);
                if (x.className.indexOf("w3-show") == -1) {
                    x.className += " w3-show";
                } else {
                    x.className = x.className.replace(" w3-show", "");
                }
            }


            if (window["WebSocket"]) {
                conn = new WebSocket("wss://{{.Host}}/ws");

                conn.onopen = function (evt) {

                    sendMessage("SendAllMessages", "null");


                 //   if ("{{with .Person}}{{.Token}}{{end}}" != "") {
                   //     sendMessage("SendAllMessages", "null");
                   // }
                }

                conn.onclose = function (evt) {
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your connection is closed. " + evt.toString() + "  </b>";
                    appendLog(item);
                };

                conn.onmessage = function (event) {

                    var message = JSON.parse(event.data);

                    if (message.content == "Unauthorized")
                        modal.style.display = "block";
                    else if (message.op == "NewUser") {
                        appendNewUser(message);
                    }
                    else if (message.content != "Ignore") {
                        console.log("here");
                        if (message.op == "ExitUser") {
                            removeUser(message);
                        }

                        console.log(message)

                        var uniqueID = message.token + "@" + message.timestamp.split(" ")[1];

                        var uberdiv = document.createElement("div");

                        // only show details for logged in users
                        if ("{{with .Person}}{{.Token}}{{end}}" != "") {
                            var diven = document.createElement("div");
                            diven.setAttribute("id", uniqueID);
                            diven.setAttribute("class", "w3-hide w3-container w3-ligth-grey fmt-row");


                        }

                        var picture_elem = document.createElement("img");
                        picture_elem.setAttribute("src", message.pictureURL);
                        var pictureURL_item = document.createElement("li");
                        pictureURL_item.setAttribute("id", "pictureURL");
                        pictureURL_item.appendChild(picture_elem);


                        var from_span = document.createElement("span");
                        from_span.setAttribute("id", "from");
                        from_span.innerText = message.sender;
                        var time_span = document.createElement("span");
                        time_span.setAttribute("id", "timestamp");
                        time_span.innerText = "[" + message.timestamp + "]";
                        var li_item = document.createElement("li");
                        li_item.appendChild(from_span);
                        li_item.appendChild(time_span);

                        var message_item = document.createElement("li");
                        message_item.setAttribute("id", "message");
                        var text_item = document.createElement("span");
                        text_item.setAttribute("id", "messageText");
                        text_item.innerText = message.content;
                        message_item.appendChild(text_item);

                        var item = document.createElement("ul");
                        item.setAttribute("id", "postitem");
                        item.appendChild((pictureURL_item));
                        item.appendChild(li_item);
                        item.appendChild(message_item);

                        var btn = document.createElement("button");
                        btn.setAttribute("class", "w3-btn");
                        btn.setAttribute("id", "postbutton");
                        btn.appendChild(item);

                        // only show details for logged in users
                        if ("{{with .Person}}{{.Token}}{{end}}" != "") {
                                btn.setAttribute("onclick", "myFunction('" + uniqueID + "')");
                            }

                        uberdiv.appendChild(btn);

                        if ("{{with .Person}}{{.Token}}{{end}}" != "") {
                         uberdiv.appendChild(diven);
                        }

                        uberdiv.setAttribute("id", "post");

                        appendLog(uberdiv);
                    }
                };
            } else {
                var item = document.createElement("div");
                item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                appendLog(item);
            }
        };


    </script>

</head>
<body>
<ul id="menu">
    <li id="leftMenu">
        <ul>
            <li>
                <a href="https://{{.Host}}/MainProfile"> <img src="/images/config.png"/></a>
            </li>
            <li>
                <a href="https://{{.Host}}/MainProfile"> <img src="/images/id_card.png"/></a>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">Room: </a>
                <div class="dropdown-content">
                    <button  id="MainButton" >Main room</button>
                    <button  id="ReimersHotelButton" >Reimers Hotel room</button>
                    <button  id="EvaMonikaMalinButton" >EvaMonikaMalin room</button>
                    <button id="JapaneseButton" >日本語屋さん</button>
                    <button id="GayButton" >Gay room</button>
                    <button id="LesbianButton" >Lesbian room</button>
                    <button id="TransButton" >Trans room</button>
                </div>
            </li>
            <li id="SelectedRoom"></li>
        </ul>
        <span id="me">{{ with .Person}}{{.FirstName}} {{.LastName}}{{end}}</span>
    </li>

    <li id="centerMenu">
        <ul id="CurrentUsers">
        </ul>
    </li>
    <li id="rightMenu">
        <div class="flex-column" style="display:{{.LoggedOut}}">
            <span>Login</span>
            <ul class="flex-row">
                <li>
                    <a href="https://{{.Host}}/google/login"><img src="/images/google.png"/></a>
                </li>
                <li>
                    <img src="/images/facebook.png"/>
                </li>
            </ul>

        </div>
        <div class="flex-column" style="display:{{.LoggedIn}}">
            <ul>
                <li >
                    <form action='https://{{.Host}}/logout' method='POST'>
                        <button type="submit"><img src="/images/home.png" border="0"/></button>
                        <input type="hidden" name="token" value="{{with .Person}}{{.Token}}{{end}}"/>
                    </form>
                </li>
                <li>
                    <span>Logout</span>
                </li>
            </ul>
        </div>
    </li>
</ul>


<div id="log"></div>
<form id="form">
    <input id="submit" type="submit" value="Send"/>
    <input type="text" id="msg"/>
</form>



<script>

    function myFunction(myid) {
        console.log("clicked" + myid);

        userId =  myid.split("@")[0]

        var x = document.getElementById(myid);
        console.log(x);
        if (x.className.indexOf("w3-show") == -1) {

            // json format
            var person = {"userId" : userId};

            $.ajax({
                url: 'https://{{.Host}}/profile',
                type: 'post',
                data: JSON.stringify(person),
                contentType : 'application/json',
                success: function (person) {

                    if (person.userId != null) {
                        var bigImage = document.createElement("img");
                        bigImage.setAttribute("src", person.pictureURL);
                        x.appendChild(bigImage);
                        var info = document.createElement("ul");
                        var info1 = document.createElement("li");
                        var info2 = document.createElement("li");
                        var info3 = document.createElement("li");
                        var info4 = document.createElement("li");
                        var info5 = document.createElement("li");
                        var info6 = document.createElement("li");

                        info1.innerText = "        " + person.nic;
                        info2.innerText = "        " + person.firstName + " " + person.lastName;
                        info3.innerText = "        " + person.gender +" "+ person.sexualOrienation;
                        info4.innerText = "        " + person.country + " " + person.town;
                        info5.innerText = "        " + "";
                        info6.innerText = "        " + person.profession;


                        info.appendChild(info1);
                        info.appendChild(info2);
                        info.appendChild(info3);
                        info.appendChild(info4);
                        info.appendChild(info5);
                        info.appendChild(info6);
                        info.setAttribute("id", "profileInfo");
                        x.appendChild(info);

                        console.log(person);
                        x.className += " w3-show";
                    }
                }
            });

          //  x.className += " w3-show";

        } else {
            while (x.lastChild) {
                x.removeChild(x.lastChild);
            }
            x.className = x.className.replace(" w3-show", "");
        }
    }
</script>


<button id="myBtn">Open Modal</button>
<!-- The Modal -->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h2>Authorization failure! </h2>
        </div>
        <div class="modal-body">
            <p>You are required to login before you may submit messages! You may automatically sign up with either your
                Google or Facebook account by clicking on corresponding icon at the top right.
            </p>
            <p>

            </p>
        </div>
        <div class="modal-footer">
            <h3>Support: Malin Lääkkö, malin@krypin.org -- sponsored by Yamato Digital Audio info@yamato.xyz</h3>
        </div>
    </div>

</div>
<script type="text/javascript" src="/js/modal.js"></script>
</body>
</html>
