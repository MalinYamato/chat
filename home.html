<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chat Example</title>
    <link href="/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="/css/menus.css" rel="stylesheet" type="text/css"/>
    <link href="/css/modal.css" rel="stylesheet" type="text/css"/>


    <script type="text/javascript">


        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {

            //ev.dataTransfer.effectAllowed = "copy";
            ev.dataTransfer.setData("text", ev.target.id);
            var data = ev.dataTransfer.getData("text", ev.target.id);
            console.log(ev.target.id);
            var current = document.getElementById("centerNenu");
            current.appendChild(document.getElementById(data));
        }

        function drop(ev) {
            //console.trace("dropped");
            ev.preventDefault();
            ev.dataTransfer.dropEffect = "copy";
            var data = ev.dataTransfer.getData("text");
            ev.target.appendChild(document.getElementById(data));
            var current = document.getElementById("centerNenu");
            current.appendChild(document.getElementById(data));


            console.log(data);

        }

        window.onload = function () {
            var conn;
            var msg = document.getElementById("msg");
            var sender = document.getElementById("sender");
            var log = document.getElementById("log");
            var currentUsers = document.getElementById("CurrentUsers");
            modal.style.display = "none";

            function appendNewUser(message) {
                var child = document.getElementById(message.token);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                }
                var newUser = document.createElement("li");
                newUser.setAttribute("id", message.token);

                image = document.createElement("img");
                image.setAttribute("src", message.pictureURL);

                newUser.appendChild(image);
                var name = document.createElement("span");
                name.innerText = message.sender;
                newUser.appendChild(name);
                currentUsers.appendChild(newUser);
            }

            function removeUser(message) {
                var child = document.getElementById(message.token);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                }
            }

            function appendLog(item) {
                var doScroll = log.scrollTop === log.scrollHeight - log.clientHeight;
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }
            }

            function sendMessage(op, msg) {
                var t = new Date();
                var time = t.getDate() + " " + t.getHours() + ":" + t.getMinutes() + ":" + t.getSeconds();
                var message = {
                    "op": op,
                    "timestamp": time,
                    "token": "{{with .Person}}{{.Token}}{{end}}",
                    "sender": "secret",
                    "pictureURL": "secret",
                    "Gender": "secret",
                    "content": msg
                };
                var json_message = JSON.stringify(message);
                console.log("send json message");
                conn.send(json_message);
                msg.value = "";
                return true;
            }


            document.getElementById("form").onsubmit = function () {

                if (!conn) {
                    return false;
                }

                if (!msg.value) {
                    return false;
                }

                sendMessage("Message",msg.value);

                msg.value = "";
                return false;
            };

            if (window["WebSocket"]) {
                conn = new WebSocket("wss://{{.Host}}/ws");

                conn.onopen = function (evt) {
                    if ("{{with .Person}}{{.Token}}{{end}}" != "") {
                    sendMessage("RequestWriteAccess", "null");
                    }
                }

                conn.onclose = function (evt) {
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your connection is closed. " + evt.toString() + "  </b>";
                    appendLog(item);
                };

                conn.onmessage = function (event) {

                    var message = JSON.parse(event.data);

                    if (message.content == "Unauthorized")
                        modal.style.display = "block";
                    else if (message.op == "NewUser") {
                        appendNewUser(message);
                    }
                    else if (message.content != "Ignore") {
                        console.log("here");
                        if (message.op == "ExitUser") {
                            removeUser(message);
                        }
                        var picture_elem = document.createElement("img");
                        picture_elem.setAttribute("src", message.pictureURL);
                        var pictureURL_item = document.createElement("li");
                        pictureURL_item.setAttribute("id", "pictureURL");
                        pictureURL_item.appendChild(picture_elem);


                        var from_span = document.createElement("span");
                        from_span.setAttribute("id", "from");
                        from_span.innerText = message.sender;
                        var time_span = document.createElement("span");
                        time_span.setAttribute("id", "timestamp");
                        time_span.innerText = "[" + message.timestamp + "]";
                        var li_item = document.createElement("li");
                        li_item.appendChild(from_span);
                        li_item.appendChild(time_span);

                        var message_item = document.createElement("li");
                        message_item.setAttribute("id", "message");
                        var text_item = document.createElement("span");
                        text_item.setAttribute("id","messageText");
                        text_item.innerText = message.content;
                        message_item.appendChild(text_item);

                        var item = document.createElement("ul");
                        item.setAttribute("id", "post");
                        item.appendChild((pictureURL_item));
                        item.appendChild(li_item);
                        item.appendChild(message_item);
                        appendLog(item);
                    }
                };
            } else {
                var item = document.createElement("div");
                item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                appendLog(item);
            }
        };
    </script>

</head>
<body>
<ul id="menu">
    <li id="leftMenu">
        <ul>
            <li>
                <img src="/images/config.png"/>
            </li>
            <li>
                <img src="/images/id_card.png"/>
            </li>
            <li>

            </li>
        </ul>
        <span id="me">{{ with .Person}}{{.FirstName}} {{.LastName}}{{end}}</span>
    </li>

    <li id="centerMenu">
        <ul id="CurrentUsers">
        </ul>
    </li>
    <li id="rightMenu">
        <div style="display:{{.LoggedOut}}">
            <ul>
                <li>
                    <span>Login</span>
                </li>
                <li>
                    <a href="https://{{.Host}}/google/login"><img src="/images/google.png"/></a>
                </li>
                <li>
                    <img src="/images/facebook.png"/>
                </li>
            </ul>
        </div>
        <div style="display:{{.LoggedIn}}">
            <ul>
                <li>
                    <span>Logout</span>
                </li>
                <li>
                    <form action='https://{{.Host}}/logout' method='POST'>
                        <button type="submit"><img src="/images/home.png" border="0"/></button>
                        <input type="hidden" name="token" value="{{with .Person}}{{.Token}}{{end}}"/>
                    </form>
                </li>
            </ul>
        </div>
    </li>
</ul>



<div id="log"></div>
<form id="form">
    <input id="submit" type="submit" value="Send"/>
    <input type="text" id="msg"/>
</form>


<button id="myBtn">Open Modal</button>
<!-- The Modal -->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h2>Authorization failure! </h2>
        </div>
        <div class="modal-body">
            <p>You are required to login before you may submit messages! You may automatically sign up with either your
                Google or Facebook account by clicking on corresponding icon at the top right.
            </p>
            <p>

            </p>
        </div>
        <div class="modal-footer">
            <h3>Support: Malin Lääkkö, malin@krypin.org -- sponsored by Yamato Digital Audio info@yamato.xyz</h3>
        </div>
    </div>

</div>
<script type="text/javascript" src="/js/modal.js"></script>
</body>
</html>
