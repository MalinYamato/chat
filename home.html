<!--
//
// Copyright 2017 Malin Lääkkö -- Yamato Digital Audio.  All rights reserved.
// https://github.com/MalinYamato
//
// Yamato Digital Audio https://yamato.xyz
//
// Redistribution and use in source and binary forms, with or without
// modification, are permitted provided that the following conditions are
// met:
//
//     * Redistributions of source code must retain the above copyright
// notice, this list of conditions and the following disclaimer.
//     * Redistributions in binary form must reproduce the above
// copyright notice, this list of conditions and the following disclaimer
// in the documentation and/or other materials provided with the
// distribution.
//     * Neither the name of Google Inc. nor the names of its
// contributors may be used to endorse or promote products derived from
// this software without specific prior written permission.
//
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
// "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Krypin Chat</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3.css">
    <link href="/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="/css/menus.css" rel="stylesheet" type="text/css"/>
    <link href="/css/modal.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/css/emojionearea.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="//twemoji.maxcdn.com/twemoji.min.js"></script>
    <script src="/js/SVGButton.js"></script>
    <script type="text/javascript"></script>
    <script type="text/javascript" src="/js/emojionearea.min.js"></script>

    <script>


        window.onload = function () {

            var el = $("#msg").emojioneArea({
                placeholder: "伝言入力",
                pickerPosition: "top",
                filtersPosition: "bottom",
                tones: true,
                inline: true,
                autocomplete: false,
                hidePickerOnBlur: false
            });
            el[0].emojioneArea.on('keydown', function(btn, event) {
                if (event.keyCode == 13 || event.which == 13) {
                    var x = document.getElementsByClassName("emojionearea-editor");
                    var aMsg = x[0].innerHTML;
                    sendMessage("Message", aMsg);
                    $(".emojionearea-editor").empty();
                }
            });

            var conn;
            var msg = document.getElementById("msg");
            var sender = document.getElementById("sender");
            var log = document.getElementById("log");
            var currentUsers = document.getElementById("CurrentUsers");
            modal.style.display = "none";

            function appendNewUser(message, uniqueID) {
                var child = document.getElementById(message.sender);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                }
                var newUser = document.createElement("li");
                newUser.setAttribute("id", message.sender);
                image = document.createElement("img");
                image.setAttribute("src", message.pictureURL);
                image.setAttribute("onclick", "RequestToPublish('" + uniqueID + "')");
                newUser.appendChild(image);
                var name = document.createElement("span");
                name.innerText = message.nic;
                newUser.appendChild(name);
                currentUsers.appendChild(newUser);
            }

            function appendNewPerson(person) {
                var newUser = document.createElement("li");
                newUser.setAttribute("id", person.userId);
                image = document.createElement("img");
                image.setAttribute("src", person.pictureURL);
                image.setAttribute("onclick", "RequestToPublish('" + getUniqueID(person.userId) + "')");
                newUser.appendChild(image);
                var name = document.createElement("span");
                name.innerText = person.nic;
                newUser.appendChild(name);
                currentUsers.appendChild(newUser);
                console.log("added user with " + person.userId)
            }

            function refreshRoomUsers(users) {
                $("#CurrentUsers").empty();
                for (key in users) {
                    appendNewPerson(users[key]);
                }
            }


            //////////////////////// Button actions settings ///////////////////////////////

            var profile = new SVGButton("#profile", "Profile", "big");
            profile.t.onmousedown = function () {
                profile.mouseDown();
                window.location = "https://{{.Host}}/MainProfile";
                };

            if (loggedIn()) {
                var logout = new SVGButton("#logoutButton", "Logout", "big");
                logout.t.onmousedown = function () {
                    logout.mouseDown();
                    $.ajax({
                        type: "POST",
                        async: false,
                        url: "https://{{.Host}}/logout",
                        data: {token: "{{.Person.Token }}"},
                        success: function (result) {
                            window.location = "https://{{.Host}}/";
                        }
                    });
                };

            }

            function changeRoom(cmd, room) {
                $.ajax({
                    type: "POST",
                    url: "https://{{.Host}}/RoomManager",
                    data: JSON.stringify({"Op": "ChangeRoom", "Room": room}),
                    contentType: 'application/json',
                    success: function (result) {
                        if (result.status != "SUCCESS") {
                            console.log("Calling RooomManger::ChangeRoom returned " + result.status + " " + result.detail );
                        }
                    }
                });
            }


            if (!loggedIn()) {

                var google = new SVGImageButton("#google", "googleIcon", "small");
                google.s.onmousedown = function () {
                    google.mouseDown();
                    window.location = "https://{{.Host}}/google/login";
                };

                var facebook = new SVGImageButton("#facebook", "facebookIcon", "small");

                var loginLabel = new SVGButton("#loginLabel", " Login", "big");

            }

            function removeUser(message) {
                var child = document.getElementById(message.sender);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                }
            }

            function appendLog(item) {
                var doScroll = log.scrollTop === log.scrollHeight - log.clientHeight;
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }


            }

            function sendMessage(op, msg) {

                console.log("called message");


                var t = new Date();
                var time = t.getDate() + " " + t.getHours() + ":" + t.getMinutes() + ":" + t.getSeconds();
                var message = {
                    "op": op,
                    "timestamp": time,
                    "token": "{{with .Person}}{{.Token}}{{end}}",
                    "sender": "secret",
                    "pictureURL": "secret",
                    "Gender": "secret",
                    "content": msg
                };
                var json_message = JSON.stringify(message);
                console.log("send json message");
                conn.send(json_message);
                msg.value = "";
                return true;
            }

            var RoomDefs = {"Main":         "Main本館",
                            "Private":      "Private 秘密屋",
                            "ReimersHotel": "Reimers Hotel屋",
                            "MalinFriends": "MalinFriens屋",
                            "Gay":          "Gayゲイ屋",
                            "Lesbian" :     "Lesbianレズ屋",
                            "Trans" :       "Trans　性転換屋",
                            "Japanese":     "日本語屋" };

            document.getElementById("MainButton").onclick = function () {
                $("#SelectedRoom").text(RoomDefs["Main"]);
                $("#log").empty();
                changeRoom("ChangeRoom", "Main");
            };
            document.getElementById("MPRButton").onclick = function () {
                $("#SelectedRoom").text(RoomDefs["Private"]);
                $("#log").empty();
                changeRoom("ChangeRoom", "MPR");
            };
            document.getElementById("ReimersHotelButton").onclick = function () {
                $("#SelectedRoom").text(RoomDefs["ReimersHotel"]);
                $("#log").empty();
                changeRoom("ChangeRoom", "ReimersHotel");
            };
            document.getElementById("EvaMonikaMalinButton").onclick = function () {
                $("#SelectedRoom").text(RoomDefs["MalinFriends"]);
                $("#log").empty();
                changeRoom("ChangeRoom", "EvaMonikaMalin");
            };
            document.getElementById("GayButton").onclick = function () {
                $("#SelectedRoom").text(RoomDefs["Gay"]);
                $("#log").empty();
                changeRoom("ChangeRoom", "Gay");
            };
            document.getElementById("LesbianButton").onclick = function () {
                $("#SelectedRoom").text(RoomDefs["Lesbian"]);
                $("#log").empty();
                changeRoom("ChangeRoom", "Lesbian");
            };
            document.getElementById("JapaneseButton").onclick = function () {
                $("#SelectedRoom").text(RoomDefs["Japaanese"]);
                $("#log").empty();
                changeRoom("ChangeRoom", "Japanese");
            };
            document.getElementById("TransButton").onclick = function () {
                $("#SelectedRoom").text(RoomDefs["Trans"]);
                $("#log").empty();
                changeRoom("ChangeRoom", "Trans");
            };

            var _id = 0;
            function getID() {
                if (_id > 1000) {
                    _id = 0;
                }
                _id++;
                return _id;
            }
            function getUniqueID(id) {
                return id + "@" + getID();
            }

            function loggedIn() {
               if ("{{with .Person}}{{.Token}}{{end}}" == "") {
                    return false;
                }
                return true;
            }

            document.getElementById("form").onsubmit = function () {
                if (!conn) {
                    return false;
                }
                if (!msg.value) {
                    return false;
                }
                sendMessage("Message", msg.value);
                msg.value = "";
                $(".emojionearea-editor").empty();
                return false;
            };

            function myFunction(id) {
                var x = document.getElementById(id);
                if (x.className.indexOf("w3-show") == -1) {
                    x.className += " w3-show";
                } else {
                    x.className = x.className.replace(" w3-show", "");
                }
            }

            function targetStatus(message, targetID) {
                var status;
                var a_to_b = false;
                var b_to_a = false;
                graph = message.graph.publishersTargets;
                basenode = message.graph.basenode;
                targetnode = targetID;
                if (basenode in graph) {
                    if (graph[basenode][targetnode] == true) {
                        a_to_b = true;
                    }
                    if (targetnode in graph) {
                        if (graph[targetnode][basenode] == true) {
                            b_to_a = true;
                        }
                    }
                    if (a_to_b && b_to_a) {
                        status = "GREEN";
                    } else {
                        status = "BLUE";
                    }
                    return status;
                }
            }




                /////////////////////////////////////////////////// WEBSOCKET ///////////////////////////////////////
                if (window["WebSocket"]) {
                    console.log("try to open connection wesbocket!");
                    conn = new WebSocket("wss://{{.Host}}/ws");

                    conn.onopen = function (evt) {
                        if (loggedIn()) {
                            $("#SelectedRoom").text(RoomDefs["{{.Person.Room}}"]);
                            changeRoom("ChangeRoom", "{{.Person.Room}}");
                        }
                        console.log("Websocket connection opened!");
                    };

                    conn.onclose = function (evt) {
                        console.log("Wesocket connection closed!: " + evt);
                        var item = document.createElement("div");
                        item.innerHTML = "<b>Your connection is closed. " + evt.toString() + "  </b>";
                        appendLog(item);
                    };

                    conn.onmessage = function (event) {
                        var message = JSON.parse(event.data);
                        if (message.content == "Unauthorized") {
                            modal.style.display = "block";

                        } else if (message.content != "Ignore") {
                            console.log("New message", message);
                            var uniqueID = message.sender + "@" + getID();
                            if (message.op == "ExitUser" && message.token != "flash") {
                                removeUser(message);
                            }
                            /////// Refress all users ////////
                            if (message.op == "RefreshRoomUsers" && message.token != "flash") {
                                refreshRoomUsers(message.roomUsers)
                                return;
                            }
                            /////// New User Arrived to this room ////////
                            if (message.op == "NewUser" && message.token != "flash") {
                                appendNewUser(message, uniqueID);
                            }

                            ////// UpdateTarget  /////////////////////////////////////////
                            if (message.op == "UpdateTargetGraph") {
                                var publist = document.getElementById("PublishList");
                                $(publist).empty();
                                for (var key1 in message.graph.publishersTargets) {
                                    console.log("key1 " + key1);
                                    if (key1 == message.graph.basenode) {
                                        for (var key2 in message.graph.publishersTargets[key1]) {
                                            console.log("key2:" + key2 + ":");

                                            stat = targetStatus(message, key2);

                                            var liIten = document.createElement("li");
                                            liIten.setAttribute("id", "Target:" + key2);
                                            var imagen = document.createElement("img");
                                            imagen.setAttribute("src", message.graph.pictures[key2]);
                                            if (stat == "GREEN") {
                                                imagen.setAttribute("style", "border-color:green; border-width: 4px; border-style:solid;")
                                            } else if (stat == "BLUE") {
                                                imagen.setAttribute("style", "border-color:blue; border-width: 4px; border-style:solid;");
                                            } else if (stat == "RED") {
                                                imagen.setAttribute("style", "border-color:red; border-width: 4px; border-style:solid;");
                                            }
                                            imagen.setAttribute("onclick", "RemoveTarget('" + key2 + "')");
                                            liIten.appendChild(imagen);
                                            publist.appendChild(liIten);
                                        }
                                    }
                                }
                                return;
                            }

                            // I do Dom not Jquery because I can, becase I am a dominatrix !!!!

                            var uberdiv = document.createElement("div");
                            // only show details for logged in users
                            if (loggedIn()) {
                                var diven = document.createElement("div");
                                diven.setAttribute("id", uniqueID);
                                diven.setAttribute("class", "w3-hide w3-container w3-ligth-grey fmt-row");
                            }
                            var picture_elem = document.createElement("img");
                            picture_elem.setAttribute("src", message.pictureURL);
                            var pictureURL_item = document.createElement("li");
                            pictureURL_item.setAttribute("id", "pictureURL");
                            pictureURL_item.appendChild(picture_elem);
                            var from_span = document.createElement("span");
                            from_span.setAttribute("id", "from");
                            from_span.innerText = message.nic;
                            var time_span = document.createElement("span");
                            time_span.setAttribute("id", "timestamp");
                            time_span.innerText = "[" + message.timestamp + "]";
                            var li_item = document.createElement("li");
                            li_item.appendChild(from_span);
                            li_item.appendChild(time_span);
                            var message_item = document.createElement("li");
                            message_item.setAttribute("id", "message");
                            var text_item = document.createElement("span");
                            text_item.setAttribute("id", "messageText");

                            text_item.innerHTML = message.content;

                            message_item.appendChild(text_item);
                            var item = document.createElement("ul");
                            item.setAttribute("id", "postitem");
                            item.appendChild((pictureURL_item));
                            item.appendChild(li_item);
                            item.appendChild(message_item);
                            var btn = document.createElement("button");
                            btn.setAttribute("class", "w3-btn");
                            btn.setAttribute("id", "postbutton");
                            btn.appendChild(item);
                            // only show details for logged in users
                            if (loggedIn()) {
                                btn.setAttribute("onclick", "myFunction('" + uniqueID + "')");
                            }
                            uberdiv.appendChild(btn);
                            if (loggedIn()) {
                                uberdiv.appendChild(diven);
                            }
                            uberdiv.setAttribute("id", "post");
                            if (message.op == "PrivateMessage") {
                                message_item.setAttribute("style", "background-color:#DEDEDE;");
                                uberdiv.setAttribute("style", "background-color:#DEDEDE;");
                                item.setAttribute("style", "background-color:#DEDEDE;");
                                btn.setAttribute("style", "background-color:#DEDEDE;");
                            }
                            appendLog(uberdiv);

                            // 'I \u2764\uFE0F emoji!';

                           // twemoji.size = '16x16';
                            //twemoji.parse(log);
                        }
                    };
                } else {
                    console.log("faile to connect to websocket");
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                    appendLog(item);
                }
        }
    </script>
</head>
<body>
<ul id="menu">
    <li id="leftMenu">
        <ul>
            <li>
                <object id="profile" class="cstuff" type="image/svg+xml" data="/images/chat.svg">
                    Profile
                </object>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">Room: </a>
                <div class="dropdown-content">
                    <button id="MainButton">Main 本館</button>
                    <button id="MPRButton">Instant Private 秘密屋</button>
                    <button id="JapaneseButton">日本語屋さん</button>
                    <button id="ReimersHotelButton">Reimers Hotel屋</button>
                    <button id="EvaMonikaMalinButton">Malin friends 屋</button>
                    <button id="GayButton">Gay ゲイ屋</button>
                    <button id="LesbianButton">Lesbian レズ屋</button>
                    <button id="TransButton">Trans 性転換屋</button>
                </div>
            </li>
            <li id="SelectedRoom"></li>
        </ul>
        <span id="me">{{ with .Person}}{{.FirstName}} {{.LastName}}{{end}}</span>
    </li>
    <li id="centerMenu">
        <ul id="CurrentUsers">  <!-- oyeaa, no more JSP, PHP or other stoneage server side stuff!!! Go Lang templating...-->
            <!-- TEMPLATE CODE -->
            {{ range .Persons}}
            <li id="{{.UserID}}"><img onclick="RequestToPublish({{.UserID}})"  src="{{.PictureURL}}"> </img><span>{{.Nic}}</span></li>
            {{end}}
            <!-- TEMPLATE CODE -->
        </ul>
    </li>
    <li id="rightMenu">
        <div class="flex-column" style="display:{{.LoggedOut}}">

        <object id="loginLabel" class="cstuff" type="image/svg+xml" data="/images/chat.svg">
            Login
        </object>

            <ul class="flex-row loggedOut">
                <li>
                    <object id="google" class="cstuff" type="image/svg+xml" data="/images/icons.svg">
                        Lobgout
                    </object>
                </li>
                <li>
                    <object id="facebook" class="cstuff" type="image/svg+xml" data="/images/icons.svg">
                        Lobgout
                    </object>
                </li>
            </ul>
        </div>
        <div class="flex-row" style="display:{{.LoggedIn}}">
            <ul>
                <li>
                  <object id="logoutButton" class="cstuff" type="image/svg+xml" data="/images/chat.svg">
                       Lobgout
                   </object>
                </li>
            </ul>
        </div>
    </li>
</ul>



<div id="log"></div>

<div class="bottom row-flex">
    <form id="form" class="row">
        <input class="row_elem" id="submit" type="submit" value="Send"/>
        <div id="stuff" class="row_elem">
            <input  type="text" id="msg"/>
        </div>
    </form>

    <ul id="PublishList" class="flex-row">
        <!-- TEMPLATE CODE -->
        {{ range .Targets}}
        <li id="Target:{{.Target.UserID}}"><img style="border-color:{{.Color}}; border-width: 4px; border-style:solid;" onclick="RemoveTarget({{.Target.UserID}})"  src="{{.Target.PictureURL}}"> </img> <!--<span>{{.Target.Nic}}</span>--> </li>
        {{end}}
        <!-- TEMPLATE CODE -->
    </ul>


</div>

<script type="text/javascript">


    function myFunction(myid) {
        console.log("clicked" + myid);
        userId = myid.split("@")[0];
        var x = document.getElementById(myid);
        console.log(x);
        if (x.className.indexOf("w3-show") == -1) {
            // json format
            var person = {"userId": userId};
            $.ajax({
                url: 'https://{{.Host}}/profile',
                type: 'post',
                data: JSON.stringify(person),
                contentType: 'application/json',
                success: function (person) {
                    if (person.userId != null) {
                        var bigImage = document.createElement("img");
                        bigImage.setAttribute("src", person.pictureURL);
                        x.appendChild(bigImage);
                        var info = document.createElement("ul");
                        var info1 = document.createElement("li");
                        var info2 = document.createElement("li");
                        var info3 = document.createElement("li");
                        var info4 = document.createElement("li");
                        var info5 = document.createElement("li");
                        var info6 = document.createElement("li");
                        info1.innerText = "        " + person.nic;
                        info2.innerText = "        " + person.firstName + " " + person.lastName;
                        info3.innerText = "        " + person.gender + " " + person.sexualOrienation;
                        info4.innerText = "        " + person.country + " " + person.town;
                        info5.innerText = "        " + "";
                        info6.innerText = "        " + person.profession;
                        info.appendChild(info1);
                        info.appendChild(info2);
                        info.appendChild(info3);
                        info.appendChild(info4);
                        info.appendChild(info5);
                        info.appendChild(info6);
                        info.setAttribute("id", "profileInfo");
                        x.appendChild(info);
                        console.log(person);
                        x.className += " w3-show";
                    }
                }
            });
        } else {
            while (x.lastChild) {
                x.removeChild(x.lastChild);
            }
            x.className = x.className.replace(" w3-show", "");
        }
    }

    //
    // AJAX is better and more secure than WS for sensitive data and structured requests that expect structured response
    //
    function RequestToPublish(anId) {
        var targetID = anId.split("@")[0];
        var message = {"op": "AddTarget", "ids": [targetID]};
        console.log("message> " + message["ids"]);
        if ($("li[id='" + "Target:" + targetID + "']").length > 0) {
            return; // dupplicate
        }
        $.ajax({
            url: 'https://{{.Host}}/TargetManager',
            type: 'post',
            data: JSON.stringify(message),
            contentType: 'application/json',
            success: function (r) {
                console.log("Add of target requested /targetManager: " + r.status.detail + " " + r.person.email);

            }
            });
    }

    function RemoveTarget(targetId)
    {
        var message = {"op": "RemoveTarget", "ids": [targetId]};
        $.ajax({
            url: 'https://{{.Host}}/TargetManager',
            type: 'post',
            data: JSON.stringify(message),
            contentType: 'application/json',
            success: function (r) {
                console.log("Delete of target requested /targetManager: " + r.status.detail + " " + r.person.email);
             //   var elem = document.getElementById("PublishList");
             //   var child = document.getElementById("Target:"+targetId);
             //   elem.removeChild(child);
            }
        });
    }

</script>


<button id="myBtn">Open Modal</button>
<!-- The Modal -->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h2>Authorization failure! </h2>
        </div>
        <div class="modal-body">
            <p>You are required to login before you may submit messages! You may automatically sign up with either your
                Google or Facebook account by clicking on corresponding icon at the top right.
            </p>
        </div>
        <div class="modal-footer">
            <h3>Support: Malin Lääkkö, malin@krypin.org -- sponsored by Yamato Digital Audio info@yamato.xyz</h3>
        </div>
    </div>

</div>
<script type="text/javascript" src="/js/modal.js"></script>
</body>
</html>
