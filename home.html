<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chat Example</title>
    <link href="/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="/css/menus.css" rel="stylesheet" type="text/css"/>
    <link href="/css/modal.css" rel="stylesheet" type="text/css"/>

    <script type="text/javascript">
        window.onload = function () {
            var conn;
            var msg = document.getElementById("msg");
            var sender = document.getElementById("sender");
            var log = document.getElementById("log");
            var currentUsers = document.getElementById("CurrentUsers");
            modal.style.display = "none";


            function appendNewUser(message) {

                var res = document.getElementById(message.pictureURL);
                if (res != null) {
                    //detected dupplicate
                    return;
                }
                var newUser = document.createElement("li");
                newUser.setAttribute("id", message.token);
                image = document.createElement("img");
                image.setAttribute("src", message.pictureURL);
                image.setAttribute("id", message.pictureURL);
                newUser.appendChild(image);
                var name = document.createElement("span");
                name.innerText = message.sender;
                newUser.appendChild(name);
                currentUsers.appendChild(newUser);
            }

            function removeUser(message) {
                var child = document.getElementById(message.token);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                    //window.alert("User removed " + status);
                }
                else {
                    window.alert("Attempt to remove an unknonw user!");
                }
            }


            function appendLog(item) {
                var doScroll = log.scrollTop === log.scrollHeight - log.clientHeight;
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }
            }

            document.getElementById("form").onsubmit = function () {

                if (!conn) {
                    return false;
                }
                if (!msg.value) {
                    return false;
                }
                // window.alert("message")
                var t = new Date();
                var time = t.getDate() + " " + t.getHours() + ":" + t.getMinutes() + ":" + t.getSeconds();
                var message = {
                    "op": "Message",
                    "timestamp": time,
                    "token": "{{with .Person}}{{.Token}}{{end}}",
                    "sender": "secret",
                    "pictureURL": "secret",
                    "Gender": "secret",
                    "content": msg.value
                };
                var json_message = JSON.stringify(message);
                conn.send(json_message);
                msg.value = "";
                return false;
            };

            if (window["WebSocket"]) {
                conn = new WebSocket("wss://{{.Host}}/ws");

                conn.onclose = function (evt) {
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your connection is closed. " + evt.toString() + "  </b>";
                    appendLog(item);
                };

                conn.onmessage = function (event) {

                    var message = JSON.parse(event.data);

                    if (message.content == "Unauthorized")
                        modal.style.display = "block";
                    else if (message.op == "NewUser") {
                        appendNewUser(message);
                    }
                    else if (message.op == "ExitUser") {
                        removeUser(message);
                    }
                    else if (message.content != "Ignore") {
                        var time_item = document.createElement("li");
                        time_item.setAttribute("id", "timestamp");

                        var picture_elem = document.createElement("img")
                        picture_elem.setAttribute("src", message.pictureURL);
                        var pictureURL_item = document.createElement("li");
                        pictureURL_item.setAttribute("id", "pictureURL");
                        pictureURL_item.appendChild(picture_elem);

                        var sender_item = document.createElement("li");
                        sender_item.setAttribute("id", "from");

                        var message_item = document.createElement("li");
                        message_item.setAttribute("id", "message");

                        sender_item.innerText = message.sender;
                        time_item.innerText = "[" + message.timestamp + "]";
                        message_item.innerText = message.content;
                        var item = document.createElement("ul");
                        item.setAttribute("id", "post");
                        item.appendChild((pictureURL_item))
                        item.appendChild(sender_item);
                        item.appendChild(message_item);
                        item.appendChild(time_item);
                        appendLog(item);
                    }
                };
            } else {
                var item = document.createElement("div");
                item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                appendLog(item);
            }

        };
    </script>


    <style type="text/css">
        html {
            overflow: hidden;
        }

        body {
            overflow: hidden;
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            background: #7994ce;
        }

        #log {
            font-size: 8mm;
            background: white;
            margin: 0;
            padding: 0.1em 0.1em 0.1em 0.1em;
            position: absolute;
            top: 2em;
            left: 0.5em;
            right: 0.5em;
            bottom: 2em;
            overflow: auto;
        }

        #form {
            padding: 0 0.5em 0 0.5em;
            margin: 0;
            position: absolute;
            bottom: 1em;
            left: 0px;
            width: 100%;
            overflow: hidden;
        }

        #msg {
            height: auto;
            font-size: 6mm;
            width: 60%;
        }

        #submit {
            height: auto;
            font-size: 6mm;
        }

        #post {
            margin-left: 2px;
            margin-top: 1px;
            height: 32px;
            background-color: white;
        }

        #post li {
            display: inline;
            list-style-type: none;
            padding-right: 2px;

        }

        #pictureURL img {
            position: relative;
            left: 0px;
            width: 30px;
            height: 30px;
            border-style: solid;
            border-color: #616161;
            border-width: 2px;
        }

        #timestamp {
            padding: 8px;
            padding-top: 18px;
            padding-left: 4px;
            font: bold 12px Arial, Helvetica, sans-serif;
            color: #616161;
        }

        #from {
            color: #7994ce;
            padding: 8px;
            padding-left: 4px;
            font: bold 24px Arial, Helvetica, sans-serif;
        }

        #message {;
            color: black;
            padding: 8px;
            padding-left: 4px;
            font: bold 24px Arial, Helvetica, sans-serif;
        }


    </style>
</head>
<body>
<ul>
    <li id="leftMenu">
        <ul>
            <li>
                <img src="/images/config.png"/>
            </li>
            <li>
                <img src="/images/id_card.png"/>
            </li>
            <li>

            </li>
        </ul>
        <span id="me">{{ with .Person}}{{.FirstName}} {{.LastName}}{{end}}</span>
    </li>


    <li id="centerMenu">
        <ul id="CurrentUsers">
        </ul>
    </li>

    <li id="rightMenu">
        <div style="visibility:{{.LoggedOut}}">
            <ul>
                <li>
                    <span>Login</span>
                </li>
                <li>
                    <a href="https://{{.Host}}/google/login"><img src="/images/google.png"/></a>
                </li>
                <li>
                    <img src="/images/facebook.png"/>
                </li>
            </ul>
        </div>
        <div style="visibility:{{.LoggedIn}}">
            <ul>
                <li>
                    <span>Logout</span>
                </li>
                <li>
                    <form action='https://{{.Host}}/logout' method='POST'>
                        <button type="submit"><img src="/images/home.png" border="0"/></button>
                        <input type="hidden" name="token" value="{{with .Person}}{{.Token}}{{end}}"/>
                    </form>
                </li>
            </ul>

        </div>
    </li>
</ul>

<div id="log"></div>
<form id="form">
    <input id="submit" type="submit" value="Send"/>
    <input type="text" id="msg"/>
</form>

<button id="myBtn">Open Modal</button>

<!-- The Modal -->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h2>Authorization failure! </h2>
        </div>
        <div class="modal-body">
            <p>You are required to login before you may submit messages! You may automatically sign up with either your
                Google or Facebook account by clicking on corresponding icon at the top right.
            </p>
            <p>

            </p>
        </div>
        <div class="modal-footer">
            <h3>Support: Malin Lääkkö, malin@krypin.org -- sponsored by Yamato Digital Audio info@yamato.xyz</h3>
        </div>
    </div>

</div>

<script>
    // Get the modal
    var modal = document.getElementById('myModal');

    // Get the button that opens the modal
    var btn = document.getElementById("myBtn");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks the button, open the modal
    btn.onclick = function () {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>

</body>
</html>
