<!--
//
// Copyright 2017 Malin Yamato LÃ¤Ã¤kkÃ¶ --  All rights reserved.
// https://github.com/MalinYamato
//
// MIT License
// Redistribution and use in source and binary forms, with or without
// modification, are permitted provided that the following conditions are
// met:
//
//     * Redistributions of source code must retain the above copyright
// notice, this list of conditions and the following disclaimer.
//     * Redistributions in binary form must reproduce the above
// copyright notice, this list of conditions and the following disclaimer
// in the documentation and/or other materials provided with the
// distribution.
//     * Neither the name of Rakuen. nor the names of its
// contributors may be used to endorse or promote products derived from
// this software without specific prior written permission.
//
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
// "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
// LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
// A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
// OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
// SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
// LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
// DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
// THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Raku Rakuen</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3.css">
    <link href="/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="/css/menus.css" rel="stylesheet" type="text/css"/>
    <link href="/css/modal.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/css/emojionearea.min.css">
    <link rel="stylesheet" href="/css/swiper.css">
    <!-- ---------------------------------------->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.0.3/adapter.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.js"></script>

    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script> -->
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.2/js/bootstrap.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.1.0/bootbox.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
    <script type="text/javascript" src="/js/janus.js"></script>
    <script type="text/javascript" src="/js/videoroom.js"></script>
    <script src="//twemoji.maxcdn.com/twemoji.min.js"></script>
    <script src="/js/SVGButton.js"></script>
    <script type="text/javascript"></script>
    <script type="text/javascript" src="/js/emojionearea.min.js"></script>
    <script src="/js/swiper.js"></script>
    <!--  <script type="text/javascript" src="videoroomtest.js"></script> -->

    <script>

        /// utilities
        ///




        function getUser(op) {
            var res = null;
            $.ajax({
                url: 'https://{{.Host}}/profile',
                type: 'post',
                async: false,
                data: JSON.stringify(op),
                contentType: 'application/json',
                success: function (response) {
                    if (response.status.status != "SUCCESS") {
                        console.log("getUser failed> " + response.status + " " + response)
                    } else {
                        console.log("getUser successul> " + response.status.status + " " + response.person.userID)
                    }
                    res = response;
                }
            });
            return res;
        }
        function getAllPublishers() {
            var res = null;
            var request = {"op": "getAllPublishers"};
            $.ajax({
                url: 'https://{{.Host}}/VideoManager',
                type: 'post',
                async: false,
                data: JSON.stringify(request),
                contentType: 'application/json',
                success: function (response) {
                    if (response.status.status != "SUCCESS") {
                        console.log("getAllPublishes failed> " + response.response.status + " " + response.status.detail)
                    } else {
                        console.log("getAllPublishers successul>")
                    }
                    res = response;
                }
            });
            return res;
        }
        function genderShort(gender) {
            if (gender == "Female") {
                return "F"
            } else if (gender == "Male") {
                return "M";
            } else {
                return "T";
            }
        }

        ///// end utilities

        window.onload = function () {

            var el = $("#msg").emojioneArea({
                placeholder: "伝言入力",
                pickerPosition: "bottom",
                filtersPosition: "bottom",
                tones: true,
                inline: true,
                autocomplete: false,
                hidePickerOnBlur: false
            });
            el[0].emojioneArea.on('keydown', function (btn, event) {
                if (event.keyCode == 13 || event.which == 13) {
                    var x = document.getElementsByClassName("emojionearea-editor");
                    var aMsg = x[0].innerHTML;
                    sendMessage("Message", aMsg);
                    $(".emojionearea-editor").empty();
                }
            });

            var conn;
            var msg = document.getElementById("msg");
            var sender = document.getElementById("sender");
            var log = document.getElementById("log");
            var currentUsers = document.getElementById("CurrentUsers");
            modal.style.display = "none";

            function appendNewUser(message, uniqueID) {
                var child = document.getElementById(message.sender);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                }
                var newUser = document.createElement("span");
                newUser.setAttribute("id", message.sender);
                image = document.createElement("img");
                image.setAttribute("src", message.pictureURL);
                image.setAttribute("onclick", "RequestToPublish('" + uniqueID + "')");
                newUser.appendChild(image);
                var name = document.createElement("span");
                name.innerText = message.nic;
                newUser.appendChild(name);
                currentUsers.appendChild(newUser);
            }
            function appendNewPerson(person) {
                var newUser = document.createElement("span");
                newUser.setAttribute("id", person.userId);
                image = document.createElement("img");
                image.setAttribute("src", person.pictureURL);
                //image.setAttribute("onclick", "RequestToPublish('" + getUniqueID(person.userId) + "')");
                image.setAttribute("onclick", "FillPersonalProfile('" + person.userId + "')");
                newUser.appendChild(image);
                var name = document.createElement("span");
                name.innerText = person.nic;
                newUser.appendChild(name);
                currentUsers.appendChild(newUser);
                console.log("added user with " + person.userId)
            }
            function refreshRoomUsers(users) {
                $("#CurrentUsers").empty();
                for (key in users) {
                    appendNewPerson(users[key]);
                }
            }

            //////////////////////// Button actions settings ///////////////////////////////

            var profile = new SVGButton("#profile", "  Profile", "L");
            profile.s.onmouseup = function () {
                profile.mouseDown();
                console.log("profile clicekd ");
                window.location = "https://{{.Host}}/MainProfile";
            };

            if (loggedIn()) {
                var logout = new SVGButton("#logoutButton", " Logout", "S");
                logout.Cloud_Text.onmousedown = function () {
                    logout.mouseDown();
                    $.ajax({
                        type: "POST",
                        async: false,
                        url: "https://{{.Host}}/logout",
                        data: {token: "{{.Person.Token }}"},
                        success: function (result) {
                            window.location = "https://{{.Host}}/";
                        }
                    });
                };
                //  var lcam = new SVGWebcamButton("#localCam", "x", "x");
                var lcam = new SVGWebcamButton("#localCam", "x", "x");
                lcam.s.onmousedown = function () {
                    console.log("clicked");
                    lcam.mouseDown();
                    lcam.toggle();
                    if (lcam.isOn()) {
                        pub();
                        if (isMuted()) {
                            console.log("audio is muted!");
                            lmic.setOff();
                        }
                        else {
                            console.log("audio is MOT muted!");
                            lmic.setOn();
                        }
                    } else if (!lcam.isOn()) {
                        unpub();
                    }
                };
                var lmic = new SVGMicrophoneButton("#localMic", "x", "x");
                lmic.s.onmousedown = function () {
                    console.log("clicked");
                    lmic.mouseDown();
                    lmic.toggle();
                    if (lmic.isOn()) {
                        unmute();
                    } else {
                        mute();
                    }
                }
                var tcam = new SVGWebcamButton("#webcam", "x", "x");
                tcam.s.onmousedown = function () {
                    //console.log("clicked");
                    tcam.mouseDown();
                    tcam.toggle();
                    if (tcam.isOn()) {
                        var response = getUser({"op": "getMyself", "UserID": "unknown"});
                        if (response.status.status == "SUCCESS") {
                            join("{{.Host}}", "{{.Host}}", response.person.nic);
                        } else {
                            console.log("getUser returned " + response.status.status + " " + response.status.detail);
                        }
                    } else if (!tcam.isOn()) {
                        leave();
                    }
                };
            }

            if (!loggedIn()) {
                var google = new SVGImageButton("#google", "google", "S");
                google.s.onmousedown = function () {
                    google.mouseDown();
                    window.location = "https://{{.Host}}/google/login";
                };
                var facebook = new SVGImageButton("#facebook", "facebook", "S");
                facebook.s.onmousedown = function () {
                    facebook.mouseDown();
                    window.location = "https://{{.Host}}/facebook/login";
                };
                var loginLabel = new SVGButton("#loginLabel", " Login", "S");
            }
            function removeUser(message) {
                var child = document.getElementById(message.sender);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                }
            }
            function appendLog(item) {
                var doScroll = log.scrollTop === log.scrollHeight - log.clientHeight;

                if (log.childNodes.length == 1) {
                    log.appendChild(item);
                }
                else {
                    log.insertBefore(item, log.childNodes[0]);
                }

                if (log.childNodes.length > 30) {
                    for (i = 30; i < log.childNodes.length; i++) {
                        log.removeChild(log.childNodes[i]);
                    }
                }
                $("#log").scrollTop(0);
            }
            function sendMessage(op, msg) {
                var t = new Date();
                var time = t.getDate() + " " + t.getHours() + ":" + t.getMinutes() + ":" + t.getSeconds();
                var message = {
                    "op": op,
                    "timestamp": time,
                    "token": "{{with .Person}}{{.Token}}{{end}}",
                    "sender": "secret",
                    "pictureURL": "secret",
                    "Gender": "secret",
                    "content": msg
                };
                var json_message = JSON.stringify(message);
                console.log("send json message");
                conn.send(json_message);
                msg.value = "";
                return true;
            }

            var _id = 0;
            function getID() {
                if (_id > 1000) {
                    _id = 0;
                }
                _id++;
                return _id;
            }
            function getUniqueID(id) {
                return id + "@" + getID();
            }
            function loggedIn() {
                if ("{{with .Person}}{{.Token}}{{end}}" == "") {
                    return false;
                }
                return true;
            }
            document.getElementById("form").onsubmit = function () {
                if (!conn) {
                    return false;
                }
                if (!msg.value) {
                    return false;
                }
                sendMessage("Message", msg.value);
                msg.value = "";
                $(".emojionearea-editor").empty();
                return false;
            };
            function myFunction(id) {
                var x = document.getElementById(id);
                if (x.className.indexOf("w3-show") == -1) {
                    x.className += " w3-show";
                } else {
                    x.className = x.className.replace(" w3-show", "");
                }
            }
            function targetStatus(message, targetID) {
                var status;
                var a_to_b = false;
                var b_to_a = false;
                graph = message.graph.publishersTargets;
                basenode = message.graph.basenode;
                targetnode = targetID;
                if (basenode in graph) {
                    if (graph[basenode][targetnode] == true) {
                        a_to_b = true;
                    }
                    if (targetnode in graph) {
                        if (graph[targetnode][basenode] == true) {
                            b_to_a = true;
                        }
                    }
                    if (a_to_b && b_to_a) {
                        status = "GREEN";
                    } else {
                        status = "BLUE";
                    }
                    return status;
                }
            }
            function UpdateTargetGraph(message) {
                var publist = document.getElementById("PublishList");
                $(publist).empty();
                for (var key1 in message.graph.publishersTargets) {
                    console.log("key1 " + key1);
                    if (key1 == message.graph.basenode) {
                        for (var key2 in message.graph.publishersTargets[key1]) {
                            console.log("key2:" + key2 + ":");

                            stat = targetStatus(message, key2);

                            var liIten = document.createElement("li");
                            liIten.setAttribute("id", "Target:" + key2);
                            liIten.setAttribute("style", "list-style-type:none");
                            var imagen = document.createElement("img");
                            imagen.setAttribute("src", message.graph.pictures[key2]);
                            if (stat == "GREEN") {
                                imagen.setAttribute("style", "border-color:green; border-width: 4px; border-style:solid;")
                            } else if (stat == "BLUE") {
                                imagen.setAttribute("style", "border-color:blue; border-width: 4px; border-style:solid;");
                            } else if (stat == "RED") {
                                imagen.setAttribute("style", "border-color:red; border-width: 4px; border-style:solid;");
                            }
                            imagen.setAttribute("onclick", "RemoveTarget('" + key2 + "')");
                            liIten.appendChild(imagen);
                            publist.appendChild(liIten);
                        }
                    }
                }
            }

            /////////////////
            /////////////////////////////////////////////////// WEBSOCKET ///////////////////////////////////////
            /////////////////
            if (window["WebSocket"]) {
                console.log("try to open connection wesbocket!");
                conn = new WebSocket("wss://{{.Host}}/ws");

                conn.onopen = function (evt) {
                    if (loggedIn()) {
                        $("#SelectedRoom").text(RoomDefs["{{.Person.Room}}"]);
                        changeRoom("{{.Person.Room}}");
                    }
                    console.log("Websocket connection opened!");
                };

                conn.onclose = function (evt) {
                    console.log("Wesocket connection closed!: " + evt);
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your connection is closed. " + evt.toString() + "  </b>";
                    appendLog(item);
                };

                conn.onmessage = function (event) {
                    var message = JSON.parse(event.data);

                    if (message.content == "Unauthorized") {
                        modal.style.display = "block";
                        return;
                    }

                    console.log("New message", message);
                    var uniqueID = message.sender + "@" + getID();

                    if (message.op == "VideoStarted") {
                        console.log("Video Started");
                    }
                    if (message.op == "VideoStopped") {
                        console.log("Video Stopped");
                    }

                    if (message.token == "flash" && message.op != "Message" && message.op != "NewUser") {
                        return;
                    } else {
                        switch (message.op) {
                            case "EnterRoom":
                                appendNewUser(message, uniqueID);
                                return;
                            case "LeaveRoom":
                                removeUser(message, uniqueID);
                                return;
                            case "UserLoggedIn" :
                                appendNewUser(message, uniqueID);
                                return;
                            case "UserLoggedOut" :
                                removeUser(message, uniqueID);
                                return;
                            case "RefreshRoomUsers":
                                refreshRoomUsers(message.roomUsers);
                                return;
                            case "NewUser":
                                appendNewUser(message, uniqueID);
                                break;
                            case "UpdateTargetGraph" :
                                UpdateTargetGraph(message);
                                return;
                        }
                    }

                    console.log("Create message ", message);

                    var uberdiv = document.createElement("div");
                    // only show details for logged in users
                    if (loggedIn()) {
                        var diven = document.createElement("div");
                        diven.setAttribute("id", uniqueID);
                        diven.setAttribute("class", "w3-hide w3-container w3-ligth-grey fmt-row");
                    }
                    var picture_elem = document.createElement("img");
                    picture_elem.setAttribute("src", message.pictureURL);
                    var pictureURL_item = document.createElement("li");
                    pictureURL_item.setAttribute("id", "pictureURL");
                    pictureURL_item.appendChild(picture_elem);
                    var from_span = document.createElement("span");
                    from_span.setAttribute("id", "from");
                    from_span.innerText = message.nic;
                    var time_span = document.createElement("span");
                    time_span.setAttribute("id", "timestamp");
                    time_span.innerText = "[" + message.timestamp + "]";
                    var li_item = document.createElement("li");
                    li_item.appendChild(from_span);
                    li_item.appendChild(time_span);
                    var message_item = document.createElement("li");
                    message_item.setAttribute("id", "message");
                    var text_item = document.createElement("span");
                    text_item.setAttribute("id", "messageText");

                    text_item.innerHTML = message.content;

                    message_item.appendChild(text_item);
                    var item = document.createElement("ul");
                    item.setAttribute("id", "postitem");
                    item.appendChild((pictureURL_item));
                    item.appendChild(li_item);
                    item.appendChild(message_item);
                    var btn = document.createElement("button");
                    btn.setAttribute("class", "w3-btn");
                    btn.setAttribute("id", "postbutton");
                    btn.appendChild(item);
                    // only show details for logged in users
                    if (loggedIn()) {
                        btn.setAttribute("onclick", "myFunction('" + uniqueID + "')");
                    }
                    uberdiv.appendChild(btn);
                    if (loggedIn()) {
                        uberdiv.appendChild(diven);
                    }
                    uberdiv.setAttribute("id", "post");
                    if (message.op == "PrivateMessage") {
                        message_item.setAttribute("style", "background-color:#DEDEDE;");
                        uberdiv.setAttribute("style", "background-color:#DEDEDE;");
                        item.setAttribute("style", "background-color:#DEDEDE;");
                        btn.setAttribute("style", "background-color:#DEDEDE;");
                    }
                    appendLog(uberdiv);
                }
            } else {
                console.log("failed to connect to websocket");
                var item = document.createElement("div");
                item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                appendLog(item);
            }
        }

    </script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.1.0/bootbox.min.js"></script>
</head>

<body>
<script>
    var RoomDefs = {
        "Main":     "Main本館",
        "Private":  "Private 秘密屋",
        "Japanese": "日本語屋",
        "Gay":      "Gayゲイ屋",
        "Lesbian":  "Lesbianレズ屋",
        "Trans":    "Trans　性転換屋",
    };
    function changeRoom(room) {
        $.ajax({
            type: "POST",
            url: "https://{{.Host}}/RoomManager",
            data: JSON.stringify({"Op": "ChangeRoom", "Room": room}),
            contentType: 'application/json',
            success: function (result) {
                if (result.status.status != "SUCCESS") {
                    console.log("Calling RooomManger::ChangeRoom returned " + result.status + " " + result.detail);
                }
            }
        });
    }
    function  SwitchRoom(room) {
        $("#SelectedRoom").text(RoomDefs[room]);
        $("#log").empty();
        changeRoom(room);
    }
</script>
<div id="menu">
    <div id="leftMenu">
        <div class="flex-row">
            <img id="rakurakuen" src="/images/rakurakuen.png"/>
            <div class="flex-column">
                <object id="profile" class="cstuff" type="image/svg+xml" data="/images/chat.svg">
                    Profile
                </object>
                <span id="me">{{ with .Person}}{{.Nic}} {{end}}</span>
            </div>
        </div>
        <div class="dropdown flex-row">
            <a href="javascript:void(0)" class="dropbtn">Room:</a>
            <div class="dropdown-content">
                <button onclick="SwitchRoom('Main')" id="MainButton">Main 本館</button>
                <button onclick="SwitchRoom('Private')" id="PrivateButton">Instant Private 秘密屋</button>
                <button onclick="SwitchRoom('Japanese')" id="JapaneseButton">日本語屋</button>
                <button onclick="SwitchRoom('Gay')" id="GayButton">Gay ゲイ屋</button>
                <button onclick="SwitchRoom('Lesbian')" id="LesbianButton">Lesbian レズ屋</button>
                <button onclick="SwitchRoom('Trans')" id="TransButton">Trans 性転換屋</button>
            </div>
            <div id="SelectedRoom"></div>
        </div>
    </div>

    <div id="centerMenu">
        <div id="CurrentUsers">
            <!-- oyeaa, no more JSP, PHP or other stoneage server side stuff!!! Go Lang templating...-->
            <!-- TEMPLATE CODE -->
        {{ range .Persons}}
            <div id="{{.UserID}}"><img onclick="RequestToPublish({{.UserID}})" src="{{.PictureURL}}"> </img>
                <span>{{.Nic}}</span></div>
        {{end}}
            <!-- TEMPLATE CODE -->
        </div>
    </div>

    <div id="rightMenu">
        <div class="flex-column" style="display:{{.LoggedOut}}">
            <object id="loginLabel" class="cstuff" type="image/svg+xml" data="/images/chat.svg">
                Login
            </object>
            <ul class="flex-row loggedOut">
                <li>
                    <object id="google" class="cstuff" type="image/svg+xml" data="/images/icons.svg">
                        Login
                    </object>
                </li>
                <li>
                    <object id="facebook" class="cstuff" type="image/svg+xml" data="/images/icons.svg">
                        Login
                    </object>
                </li>
            </ul>
        </div>
        <div class="flex-row" style="display:{{.LoggedIn}}">
            <ul>
                <li>
                    <object id="logoutButton" class="cstuff" type="image/svg+xml" data="/images/chat.svg">
                        Logout
                    </object>
                </li>
                <li>
                    <object class="webcam" id="webcam" type="image/svg+xml"
                            data="https://{{.Host}}/images/webcam.svg"></object>
            </ul>
        </div>
    </div>
</div>

<button hidden class="btn btn-default" autocomplete="off" id="start">Start</button>


<div id="profileArea" hidden>
    <div class="ProfileArea">
        <div class="flex-row">
            <div class="flex-column">
                <div class="flex-row">
                    <img id="ProfilePicture" src=""/>
                    <ul id="profileItems"></ul>
                </div>
                <ul id="profileItemsOther"></ul>
                <div class="flex-row">
                    <img class="Mail" src="/images/mail.svg"/>
                    <img id="privateChat" src=""/>
                    <img onclick="closeProfileView()" class="CloseProfileViewBtn" src="/images/error.png"/>
                </div>
            </div>

            <div id="pictures" class="ProfilePictures">
                <div class="slideshow" onmouseup="phtoBoxMouseUp()" id="photos">
                    <!-- Swiper -->
                    <div class="swiper-container gallery-top">
                        <div class="swiper-wrapper">
                        </div>
                        <!-- Add Arrows -->
                        <div class="swiper-button-next swiper-button-white"></div>
                        <div class="swiper-button-prev swiper-button-white"></div>
                    </div>
                    <div class="swiper-container gallery-thumbs">
                        <div class="swiper-wrapper">
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <p id="description"></p>
    </div>
</div>


<script>
    var galleryTop = new Swiper('.gallery-top', {
        nextButton: '.swiper-button-next',
        prevButton: '.swiper-button-prev',
        spaceBetween: 10,
        grabCursor: true,
        centeredSlides: true,
        slidesPerView: 'auto'
    });

    function phtoBoxMouseUp(e)
    {
        galleryTop.update(true);
    }
    function getImages(request) {
        galleryTop.removeAllSlides();
      //  galleryThumbs.removeAllSlides();
        $.ajax({
            url: 'https://{{.Host}}/ImageManagerGet',
            type: 'post',
            data: JSON.stringify(request),
            contentType: 'application/json',
            success: function (r) {
                console.log("Done......>! ", r.status + " " + r.images.length );
                for (i = 0; i < (r.images).length; i++) {
                    var s = '<div id="' + r.images[i]["normal"] + '" class="swiper-slide" style="background-image:url(' +  r.images[i]["normal"] + '") >  <img src=" ' + r.images[i]["normal"] + '" /></div>';
                    galleryTop.appendSlide(s);
                  //  galleryThumbs.appendSlide('<div id="' + r.images[i]["small"] + '" class="swiper-slide" style="background-image:url(' +  r.images[i]["small"] + '") ></div>');
                    console.log(r.images[i]["small"]);
                }
                galleryTop.update(true);
                // galleryThumbs.update(true);
            }
        });
    }
    function creeteListItem(label_text, item_data) {
        if (item_data == undefined) {
            item_data = "";
        }
        var item = document.createElement("li");
        item.setAttribute("class","flex-row");
        if (label_text != "" || label_text == undefined) {
            var label = document.createElement("div");
            label.setAttribute("class", "ProfileItemLabel");
            label.innerText = label_text;
            item.appendChild(label);
        }
        var text = document.createElement("div");
        text.setAttribute("class","ProfileItemValue");
        text.innerText = item_data;
        item.appendChild(text)
        return item;
    }
    function FillPersonalProfile(userId) {
        console.log("UserID >> " + userId);
        var response = getUser( {"op": "getUserByID", "userID": userId});
        var user = response.person;
        var list = document.getElementById("profileItems");
        var listOthers = document.getElementById("profileItemsOther");
        $("#profileItems").empty();
        $("#profileItemsOther").empty();
        list.appendChild( creeteListItem("",user.nic + " " + getAge(user)));
        list.appendChild( creeteListItem("",user.gender));
        list.appendChild( creeteListItem("",user.town + " " + user.country));
        listOthers.appendChild( creeteListItem("Style ",user.sexualOrientation));
        listOthers.appendChild( creeteListItem("Status ","Single"));
        listOthers.appendChild( creeteListItem("Work ",user.profession));
        listOthers.appendChild( creeteListItem("Education ",user.education));
        var myStory = document.getElementById("description");

        if  (user.description == undefined ) {
                  myStory.innerText = "";
        } else {
            myStory.innerText =       user.description
        }
        var profilePicture = document.getElementById("ProfilePicture");
        profilePicture.setAttribute("src", user.pictureURL );
        var privateChat = document.getElementById("privateChat");
        privateChat.setAttribute("src", user.pictureURL );

        response = getImages({'op':'getImages', 'userID':userId});
        $("#profileArea").show();
    }
    function closeProfileView() {
        $("#profileArea").hide();
    }
</script>

<div id="publishers"></div>

<div id="camArea">
    <div class="flex-container videos" id="videos">
        <div class="flex-row">
            <div class="screen flexer " id="screen1">
                <div class=" narrow" id="videolocal">
                    <div class="videocontrols">
                        <object id="localCam" class="" type="image/svg+xml" data="/images/webcam.svg">
                            Local Cam
                        </object>
                        <label id="camUser1">User</label>
                        <object id="localMic" class="" type="image/svg+xml" data="/images/microphone.svg">
                            Local Cam
                        </object>
                    </div>
                </div>
            </div>
            <div class="screen flexer" id="screen2">
                <div class=" narrow " id="videoremote1">
                    <div class="videocontrols">
                        <div class="VideoSelection">
                            <img class="VideoMenu" onclick="VideoMenuClicked('1')" src="/images/menu.svg"/>
                            <div id="VideoMenu1" class="w3-hide w3-container fmt-row"></div>
                        </div>
                        <label id="camUser2">User</label>
                    </div>
                </div>
            </div>
            <div class="screen flexer" id="screen3">
                <div class=" narrow " id="videoremote2">
                    <div class=" narrow " id="videoremote1">
                        <div class="videocontrols">
                            <div class="VideoSelection">
                                <img class="VideoMenu" onclick="VideoMenuClicked('2')" src="/images/menu.svg"/>
                                <div id="VideoMenu2" class="w3-hide w3-container fmt-row"></div>
                            </div>
                            <label id="camUser3">User</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function VideoMenuClicked(videoID) {
        removePublisherMenu(videoID);
        var menu = document.getElementById("VideoMenu" + videoID);
        var cls = menu.getAttribute("class");
        if (cls.includes("w3-show")) {
            hideVideoMenu(videoID);
        } else {
            $("#VideoMenu" + videoID.toString()).empty();
            var list = document.createElement("ul");
            list.setAttribute("class", "VideoMenuList");
            var attach = document.createElement("li");
            attach.setAttribute("onclick", "attachTheVideo(" + videoID + ")");
            attach.innerText = "Attach";
            var detach = document.createElement("li");
            detach.innerText = "Detach";
            detach.setAttribute("onclick", "detachTheVideo(" + videoID + ")");
            var info = document.createElement("li");
            info.innerText = "Info";
            info.setAttribute("onclick", "toggleInfo(" + videoID + ")");
            list.appendChild(attach);
            list.appendChild(detach);
            list.appendChild(info);
            menu.appendChild(list);
            menu.className += " w3-show";
        }
    }
    function toggleInfo(videoId) {
        toggleOnOffVideoInfo(videoId);
    }
    function publisherSelected(value) {
        removePublisherMenu();
        setRemoteCam(value);
    }
    function removePublisherMenu() {
        $("#publishers").empty();
    }
    function hideVideoMenu(videoId) {
        var menu = document.getElementById("VideoMenu" + videoId);
        menu.className = menu.className.replace("w3-show", "");
    }
    function attachTheVideo(videoId) {
        hideVideoMenu(videoId);
        console.log("attachVideo " + videoId);
        var result = getAllPublishers();
        $("#publishers").empty();
        var list = document.createElement("ul");
        list.setAttribute("class", "PublisherList");
        for (var i = 0; i < result.persons.length; i++) {
            var user = document.createElement("li");
            var camID = getCamId(result.persons[i].token);
            user.setAttribute("class", "PublisherListItem");
            user.setAttribute("onclick", "publisherSelected('" + videoId + ":" + camID.toString() + "')");
            user.innerText = result.persons[i].nic + " " + genderShort(result.persons[i].gender);
            list.appendChild(user);
        }
        var pubs = document.getElementById("publishers");
        pubs.appendChild(list);
        var cancel = document.createElement("li");
        var img = document.createElement("img");
        img.setAttribute("src", "/images/error.png");
        img.setAttribute("onclick", "removePublisherMenu()");


        cancel.appendChild(img);
       // cancel.setAttribute("class", "PublisherListItem");

        cancel.setAttribute("onclick", "removePublisherMenu()");
        list.appendChild(cancel);
    }
    function detachTheVideo(videoId) {
        hideVideoMenu(videoId);
        detachVideo(videoId);
        console.log("detachVideo " + videoId);
    }
</script>

<div id="chatform" class="row-flex">
    <form id="form" class="row">
        <input class="row_elem" id="submit" type="submit" value="Send"/>
        <div id="stuff" class="row_elem">
            <input type="text" id="msg"/>
        </div>
    </form>
    <div id="PublishList" class="flex-row">
        <!-- TEMPLATE CODE -->
    {{ range .Targets}}
        <div id="Target:{{.Target.UserID}}"><img style="border-color:{{.Color}}; border-width: 4px; border-style:solid;"
                                                 onclick="RemoveTarget({{.Target.UserID}})"
                                                 src="{{.Target.PictureURL}}"> </img>
            <!--<span>{{.Target.Nic}}</span>--> </div>
    {{end}}
        <!-- TEMPLATE CODE -->
    </div>
</div>

<div id="log"></div>

<script type="text/javascript">
    var cams = ["cam1", "cam2"];

    function setRemoteCam(response) {
        var data = response.split(":");
        console.log("setRemoteCam " + data);
        for (var i = 0; i < cams.length; i++) {
            var aCam = document.getElementById(cams[i]);
            if (aCam != null) {
                aCam.setAttribute("src", "/images/webcam.svg");
            }
        }
        var cam = document.getElementById("cam" + data[0]);
        if (cam != null) {
            cam.setAttribute("src", "/images/webcamOn.svg ");
        }
        subscribe(data[0], parseInt(data[1]));
    }

    function getAge(person) {
        var t = new Date();
        var age = t.getFullYear() - parseInt(person.birthDate.year);
        if (t.getMonth() < parseInt(person.birthDate.month)) {
            age = age - 1;
        }
        return age;
    }

    function myFunction(myid) {
        console.log("clicked" + myid);
        userId = myid.split("@")[0];
        var x = document.getElementById(myid);
        console.log(x);
        if (x.className.indexOf("w3-show") == -1) {
            // json format
            var request = {"op": "getUserByID", "userID": userId};
            var response = getUser(request);
            if (response.status.status == "SUCCESS" && response.person != null && response.person != "") {
                var person = response.person;
                var age = getAge(person);
                var bigImage = document.createElement("img");
                bigImage.setAttribute("src", person.pictureURL);
                x.appendChild(bigImage);
                var info = document.createElement("ul");
                var info1 = document.createElement("li");
                var info2 = document.createElement("li");
                var info3 = document.createElement("li");
                var info4 = document.createElement("li");
                var info5 = document.createElement("li");
                var info6 = document.createElement("li");

                info1.innerText = "        " + person.nic + " " + age;
                info3.innerText = "        " + person.gender + " " + person.sexualOrienation;
                info4.innerText = "        " + person.country + " " + person.town;
                info5.innerText = "        " + "";
                info6.innerText = "        " + person.profession;
                info.appendChild(info1);
                info.appendChild(info2);
                info.appendChild(info3);
                info.appendChild(info4);
                info.appendChild(info5);
                info.appendChild(info6);
                info.setAttribute("id", "profileInfo");

                var camID = getCamId(person.token);
                if (camID != null) {
                    for (var i = 0; i < cams.length; i++) {
                        var aCam = cams[i];
                        var o = document.createElement("img");
                        o.setAttribute("src", "/images/webcam.svg");
                        o.setAttribute("class", "smallWebCam");
                        c = i + 1;
                        o.setAttribute("onclick", "setRemoteCam('" + c + ":" + camID.toString() + "')");
                        o.setAttribute("id", aCam);
                        info.appendChild(o);
                    }
                }
                x.appendChild(info);
                console.log(person);
                x.className += " w3-show";
            }
        } else {
            while (x.lastChild) {
                x.removeChild(x.lastChild);
            }
            x.className = x.className.replace(" w3-show", "");
        }
    }

    //
    // AJAX is better and more secure than WS for sensitive data and structured requests that expect structured response
    //
    function RequestToPublish(anId) {
        var targetID = anId.split("@")[0];
        var message = {"op": "AddTarget", "ids": [targetID]};
        console.log("message> " + message["ids"]);
        if ($("li[id='" + "Target:" + targetID + "']").length > 0) {
            return; // dupplicate
        }
        $.ajax({
            url: 'https://{{.Host}}/TargetManager',
            type: 'post',
            data: JSON.stringify(message),
            contentType: 'application/json',
            success: function (r) {
                console.log("Add of target requested /targetManager: " + r.status.detail + " " + r.person.email);
            }
        });
    }
    function RemoveTarget(targetId) {
        var message = {"op": "RemoveTarget", "ids": [targetId]};
        $.ajax({
            url: 'https://{{.Host}}/TargetManager',
            type: 'post',
            data: JSON.stringify(message),
            contentType: 'application/json',
            success: function (r) {
                console.log("Delete of target requested /targetManager: " + r.status.detail + " " + r.person.email);
                //   var elem = document.getElementById("PublishList");
                //   var child = document.getElementById("Target:"+targetId);
                //   elem.removeChild(child);
            }
        });
    }
</script>

<button id="myBtn">Open Modal</button>
<!-- The Modal -->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h2>Authorization failure! </h2>
        </div>
        <div class="modal-body">
            <p>You are required to login before you may submit messages! You may automatically sign up with either your
                Google or Facebook account by clicking on corresponding icon at the top right.
            </p>
        </div>
        <div class="modal-footer">
            <h3>Support: Malin Yamato LÃ¤Ã¤kkÃ¶, malin@raku.cloud -- sponsored by Yamato Digital Audio
                info@yamato.xyz</h3>
        </div>
    </div>
</div>
<script type="text/javascript" src="/js/modal.js"></script>
</body>
</html>
