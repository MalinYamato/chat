<!--
// (C) 2017 Yamato Digital Audio
// Author: Malin af Lääkkö
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chat Example</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3.css">
    <link href="/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="/css/menus.css" rel="stylesheet" type="text/css"/>
    <link href="/css/modal.css" rel="stylesheet" type="text/css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript">

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {

            //ev.dataTransfer.effectAllowed = "copy";
            ev.dataTransfer.setData("text", ev.target.id);
            var data = ev.dataTransfer.getData("text", ev.target.id);
            console.log(ev.target.id);
            var current = document.getElementById("centerNenu");
            current.appendChild(document.getElementById(data));
        }

        function drop(ev) {
            //console.trace("dropped");
            ev.preventDefault();
            ev.dataTransfer.dropEffect = "copy";
            var data = ev.dataTransfer.getData("text");
            ev.target.appendChild(document.getElementById(data));
            var current = document.getElementById("centerNenu");
            current.appendChild(document.getElementById(data));
        }

        window.onload = function () {
            var conn;
            var msg = document.getElementById("msg");
            var sender = document.getElementById("sender");
            var log = document.getElementById("log");
            var currentUsers = document.getElementById("CurrentUsers");
            modal.style.display = "none";

            function appendNewUser(message, uniqueID) {
                var child = document.getElementById(message.sender);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                }
                var newUser = document.createElement("li");
                newUser.setAttribute("id", message.sender);
                image = document.createElement("img");
                image.setAttribute("src", message.pictureURL);
                image.setAttribute("onclick", "RequestToPublish('" + uniqueID + "')");
                newUser.appendChild(image);
                var name = document.createElement("span");
                name.innerText = message.nic;
                newUser.appendChild(name);
                currentUsers.appendChild(newUser);
            }

            function removeUser(message) {
                var child = document.getElementById(message.sender);
                if (child != null) {
                    var status = currentUsers.removeChild(child);
                }
            }

            function appendLog(item) {
                var doScroll = log.scrollTop === log.scrollHeight - log.clientHeight;
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }
            }

            function sendMessage(op, msg) {
                var t = new Date();
                var time = t.getDate() + " " + t.getHours() + ":" + t.getMinutes() + ":" + t.getSeconds();
                var message = {
                    "op": op,
                    "timestamp": time,
                    "token": "{{with .Person}}{{.Token}}{{end}}",
                    "sender": "secret",
                    "pictureURL": "secret",
                    "Gender": "secret",
                    "content": msg
                };
                var json_message = JSON.stringify(message);
                console.log("send json message");
                conn.send(json_message);
                msg.value = "";
                return true;
            }

            document.getElementById("MainButton").onclick = function () {
                $("#SelectedRoom").text("Main本館");
                $("#log").empty();
                sendMessage("ChangeRoom", "Main");
            };
            document.getElementById("MPRButton").onclick = function () {
                $("#SelectedRoom").text("Instant Private 秘密屋");
                $("#log").empty();
                sendMessage("ChangeRoom", "MPR");
            };
            document.getElementById("ReimersHotelButton").onclick = function () {
                $("#SelectedRoom").text("Reimers Hotel屋");
                $("#log").empty();
                sendMessage("ChangeRoom", "ReimersHotel");
            };
            document.getElementById("EvaMonikaMalinButton").onclick = function () {
                $("#SelectedRoom").text("EvaMonikaMalin屋");
                $("#log").empty();
                sendMessage("ChangeRoom", "EvaMonikaMalin");
            };
            document.getElementById("GayButton").onclick = function () {
                $("#SelectedRoom").text("Gayゲイ屋");
                $("#log").empty();
                sendMessage("ChangeRoom", "Gay");
            };
            document.getElementById("LesbianButton").onclick = function () {
                $("#SelectedRoom").text("Lesbianレズ屋");
                $("#log").empty();
                sendMessage("ChangeRoom", "Lesbian");
            };
            document.getElementById("JapaneseButton").onclick = function () {
                $("#SelectedRoom").text("日本語屋");
                $("#log").empty();
                sendMessage("ChangeRoom", "Japanese");
            };
            document.getElementById("TransButton").onclick = function () {
                $("#SelectedRoom").text("Trans　性転換屋");
                $("#log").empty();
                sendMessage("ChangeRoom", "Trans");
            };

            var _id = 0;
            function getID() {
                if (_id > 1000) {
                    _id = 0;
                }
                _id++;
                return _id;
            }

            function loggedIn() {
                if ("{{with .Person}}{{.Token}}{{end}}" != " ") {
                    return true;
                }
                return false;
            }

            document.getElementById("form").onsubmit = function () {
                if (!conn) {
                    return false;
                }
                if (!msg.value) {
                    return false;
                }
                sendMessage("Message", msg.value);
                msg.value = "";
                return false;
            };

            function myFunction(id) {
                console.log("clicked");
                var x = document.getElementById(id);
                if (x.className.indexOf("w3-show") == -1) {
                    x.className += " w3-show";
                } else {
                    x.className = x.className.replace(" w3-show", "");
                }
            }
            function targetStatus(message, targetID) {
                var status;
                var a_to_b = false;
                var b_to_a = false;

                console.log("here");

                graph = message.graph.publishersTargets;
                basenode = message.basenode;
                targetnode = targetID;

                if(graph[basenode][targetnode] == true) {
                    a_to_b = true;
                }

                console.log("here2");
                console.log("here2 t " + targetnode);
                console.log("here2 b " + basenode);

                if (graph[targetnode][basenode] == true) {
                    b_to_a = true;
                }
                console.log("here3");

                if (a_to_b && b_to_a) {
                    status = "GREEN";
                } else {
                    status = "BLUE";
                }
                return status;
            }


            /////////////////////////////////////////////////// WEBSOCET STUFF ///////////////////////////////////////
            if (window["WebSocket"]) {
                conn = new WebSocket("wss://{{.Host}}/ws");

                conn.onopen = function (evt) {
                    console.log("Websocket connection opened!")
                    sendMessage("SendAllMessages", "null");
                };

                conn.onclose = function (evt) {
                    console.log("Wesocket connection closed!: " + evt)
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your connection is closed. " + evt.toString() + "  </b>";
                    appendLog(item);
                };

                conn.onmessage = function (event) {
                    var message = JSON.parse(event.data);
                    if (message.content == "Unauthorized") {
                        modal.style.display = "block";

                    } else if (message.content != "Ignore") {
                        console.log("New message", message);
                        var uniqueID = message.sender +"@" + getID();
                        if (message.op == "ExitUser" && message.token != "flash") {
                            removeUser(message);
                        }
                        /////// NewUser //////////////////////////////////////////////
                        if (message.op == "NewUser" && message.token != "flash") {
                            appendNewUser(message, uniqueID);
                        }
                        ////// UpdateTarget  /////////////////////////////////////////
                        if (message.op == "UpdateTargetGraph") {
                            var publist = document.getElementById("PublishList");
                            $(publist).empty();
                            for (var key1 in message.graph.publishersTargets) {
                                console.log("key1 " + key1);
                                if (key1 == message.graph.basenode) {
                                for (var key2 in message.graph.publishersTargets[key1]) {
                                    console.log("key2:" + key2 + ":");

                                    stat = targetStatus(message, key2);

                                    var liIten = document.createElement("li");
                                    liIten.setAttribute("id", "Target:" + key2);
                                    var imagen = document.createElement("img");
                                    imagen.setAttribute("src", message.graph.pictures[key2]);
                                    if (stat == "GREEN") {
                                        imagen.setAttribute("style", "border-color:green; border-width: 4px; border-style:solid;")
                                    } else if (stat == "BLUE") {
                                        imagen.setAttribute("style", "border-color:blue; border-width: 4px; border-style:solid;");
                                    } else if (stat == "RED") {
                                        imagen.setAttribute("style", "border-color:red; border-width: 4px; border-style:solid;");
                                    }
                                    imagen.setAttribute("onclick", "RemoveTarget('" + key2 + "')");
                                    liIten.appendChild(imagen);
                                    publist.appendChild(liIten);
                                }
                            }
                            }
                            return;
                          }

                        // I do Dom not Jquery because I can, becase I am a dominatrix !!!!

                        var uberdiv = document.createElement("div");
                        // only show details for logged in users
                        if (loggedIn()) {
                            var diven = document.createElement("div");
                            diven.setAttribute("id", uniqueID);
                            diven.setAttribute("class", "w3-hide w3-container w3-ligth-grey fmt-row");
                        }
                        var picture_elem = document.createElement("img");
                        picture_elem.setAttribute("src", message.pictureURL);
                        var pictureURL_item = document.createElement("li");
                        pictureURL_item.setAttribute("id", "pictureURL");
                        pictureURL_item.appendChild(picture_elem);
                        var from_span = document.createElement("span");
                        from_span.setAttribute("id", "from");
                        from_span.innerText = message.nic;
                        var time_span = document.createElement("span");
                        time_span.setAttribute("id", "timestamp");
                        time_span.innerText = "[" + message.timestamp + "]";
                        var li_item = document.createElement("li");
                        li_item.appendChild(from_span);
                        li_item.appendChild(time_span);
                        var message_item = document.createElement("li");
                        message_item.setAttribute("id", "message");
                        var text_item = document.createElement("span");
                        text_item.setAttribute("id", "messageText");
                        text_item.innerText = message.content;
                        message_item.appendChild(text_item);
                        var item = document.createElement("ul");
                        item.setAttribute("id", "postitem");
                        item.appendChild((pictureURL_item));
                        item.appendChild(li_item);
                        item.appendChild(message_item);
                        var btn = document.createElement("button");
                        btn.setAttribute("class", "w3-btn");
                        btn.setAttribute("id", "postbutton");
                        btn.appendChild(item);
                        // only show details for logged in users
                        if (loggedIn()) {
                            btn.setAttribute("onclick", "myFunction('" + uniqueID + "')");
                        }
                        uberdiv.appendChild(btn);
                        if (loggedIn()) {
                            uberdiv.appendChild(diven);
                        }
                        uberdiv.setAttribute("id", "post");
                        if (message.op == "PrivateMessage") {
                            message_item.setAttribute("style", "background-color:#DEDEDE;");
                            uberdiv.setAttribute("style", "background-color:#DEDEDE;");
                            item.setAttribute("style", "background-color:#DEDEDE;");
                            btn.setAttribute("style", "background-color:#DEDEDE;");
                        }
                        appendLog(uberdiv);
                    }
                };
            } else {
                var item = document.createElement("div");
                item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                appendLog(item);
            }
        };
    </script>
</head>
<body>
<ul id="menu">
    <li id="leftMenu">
        <ul>
            <li>
                <a href="https://{{.Host}}/MainProfile">
                    <div id="ProfileImage"></div>
                </a>
            </li>
            <li class="dropdown">
                <a href="javascript:void(0)" class="dropbtn">Room: </a>
                <div class="dropdown-content">
                    <button id="MainButton">Main 本館</button>
                    <button id="MPRButton">Instant Private 秘密屋</button>
                    <button id="JapaneseButton">日本語屋さん</button>
                    <button id="ReimersHotelButton">Reimers Hotel屋</button>
                    <button id="EvaMonikaMalinButton">EvaMonikaMali屋</button>
                    <button id="GayButton">Gay ゲイ屋</button>
                    <button id="LesbianButton">Lesbian レズ屋</button>
                    <button id="TransButton">Trans 性転換屋</button>
                </div>
            </li>
            <li id="SelectedRoom"></li>
        </ul>
        <span id="me">{{ with .Person}}{{.FirstName}} {{.LastName}}{{end}}</span>
    </li>
    <li id="centerMenu">
        <ul id="CurrentUsers">  <!-- oyeaa, no more JSP, PHP or other stoneage server side stuff!!! Go Lang templating...-->
            <!-- TEMPLATE CODE -->
            {{ range .Persons}}
            <li id="{{.UserID}}"><img onclick="RequestToPublish({{.UserID}})"  src="{{.PictureURL}}"> </img><span>{{.Nic}}</span></li>
            {{end}}
            <!-- TEMPLATE CODE -->
        </ul>
    </li>
    <li id="rightMenu">
        <div class="flex-column" style="display:{{.LoggedOut}}">
            <span>Login</span>
            <ul class="flex-row loggedOut">
                <li>
                    <a href="https://{{.Host}}/google/login"><img src="/images/google.png"/></a>
                </li>
                <li>
                    <img src="/images/facebook.png"/>
                </li>
            </ul>
        </div>
        <div class="flex-row" style="display:{{.LoggedIn}}">
            <ul>
                <li>
                    <form id="pingu" action='https://{{.Host}}/logout' method='POST'>

                        <button type="submit"><img src="/images/pingu.png" border="0"/></button>
                        <input type="hidden" name="token" value="{{with .Person}}{{.Token}}{{end}}"/>
                    </form>
                </li>
            </ul>
        </div>
    </li>
</ul>

<div id="log"></div>

<div class="bottom flex-row">
    <form id="form">
        <input id="submit" type="submit" value="Send"/>
        <input type="text" id="msg"/>
    </form>
    <ul id="PublishList" class="flex-row">
        <!-- TEMPLATE CODE -->
        {{ range .Targets}}
        <li id="Target:{{.Target.UserID}}"><img style="border-color:{{.Color}}; border-width: 4px; border-style:solid;" onclick="RemoveTarget({{.Target.UserID}})"  src="{{.Target.PictureURL}}"> </img> <!--<span>{{.Target.Nic}}</span>--> </li>
        {{end}}
        <!-- TEMPLATE CODE -->
    </ul>
</div>

<script>

    function myFunction(myid) {
        console.log("clicked" + myid);
        userId = myid.split("@")[0]
        var x = document.getElementById(myid);
        console.log(x);
        if (x.className.indexOf("w3-show") == -1) {
            // json format
            var person = {"userId": userId};
            $.ajax({
                url: 'https://{{.Host}}/profile',
                type: 'post',
                data: JSON.stringify(person),
                contentType: 'application/json',
                success: function (person) {
                    if (person.userId != null) {
                        var bigImage = document.createElement("img");
                        bigImage.setAttribute("src", person.pictureURL);
                        x.appendChild(bigImage);
                        var info = document.createElement("ul");
                        var info1 = document.createElement("li");
                        var info2 = document.createElement("li");
                        var info3 = document.createElement("li");
                        var info4 = document.createElement("li");
                        var info5 = document.createElement("li");
                        var info6 = document.createElement("li");
                        info1.innerText = "        " + person.nic;
                        info2.innerText = "        " + person.firstName + " " + person.lastName;
                        info3.innerText = "        " + person.gender + " " + person.sexualOrienation;
                        info4.innerText = "        " + person.country + " " + person.town;
                        info5.innerText = "        " + "";
                        info6.innerText = "        " + person.profession;
                        info.appendChild(info1);
                        info.appendChild(info2);
                        info.appendChild(info3);
                        info.appendChild(info4);
                        info.appendChild(info5);
                        info.appendChild(info6);
                        info.setAttribute("id", "profileInfo");
                        x.appendChild(info);
                        console.log(person);
                        x.className += " w3-show";
                    }
                }
            });
        } else {
            while (x.lastChild) {
                x.removeChild(x.lastChild);
            }
            x.className = x.className.replace(" w3-show", "");
        }
    }

    //
    // AJAX is better and more secure than WS for sensitive data and structured requests that expect structured response
    //
    function RequestToPublish(anId) {
        var targetID = anId.split("@")[0];
        var message = {"op": "AddTarget", "ids": [targetID]};
        console.log("message> " + message["ids"]);
        if ($("li[id='" + "Target:" + targetID + "']").length > 0) {
            return; // dupplicate
        }
        $.ajax({
            url: 'https://{{.Host}}/TargetManager',
            type: 'post',
            data: JSON.stringify(message),
            contentType: 'application/json',
            success: function (r) {
                console.log("Add of target requested /targetManager: " + r.status.detail + " " + r.person.email);

            }
            });
    }

    function RemoveTarget(targetId)
    {
        var message = {"op": "RemoveTarget", "ids": [targetId]};
        $.ajax({
            url: 'https://{{.Host}}/TargetManager',
            type: 'post',
            data: JSON.stringify(message),
            contentType: 'application/json',
            success: function (r) {
                console.log("Delete of target requested /targetManager: " + r.status.detail + " " + r.person.email);
             //   var elem = document.getElementById("PublishList");
             //   var child = document.getElementById("Target:"+targetId);
             //   elem.removeChild(child);
            }
        });
    }

</script>


<button id="myBtn">Open Modal</button>
<!-- The Modal -->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h2>Authorization failure! </h2>
        </div>
        <div class="modal-body">
            <p>You are required to login before you may submit messages! You may automatically sign up with either your
                Google or Facebook account by clicking on corresponding icon at the top right.
            </p>
        </div>
        <div class="modal-footer">
            <h3>Support: Malin Lääkkö, malin@krypin.org -- sponsored by Yamato Digital Audio info@yamato.xyz</h3>
        </div>
    </div>

</div>
<script type="text/javascript" src="/js/modal.js"></script>
</body>
</html>
